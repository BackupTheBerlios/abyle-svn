# Copyright (C) 2005  Stefan Nistelberger (scuq@gmx.net)
# abyle fw script - python iptables config script
# abyle_firewall.py
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
# http://www.gnu.org/licenses/gpl.txt

import re
import os
import string
import time
import datetime
from abyle_output import abyle_output
from abyle_log import abyle_log2file
from abyle_xmlparser import abyleparse
from abyle_config_xmlparser import abyle_config_parse

from xml.sax.handler import ContentHandler
from xml.sax import make_parser


class abyle_firewall:
	def __init__(self, dryrun, iptablesbin, fwconfigpath, rulesfile, syncookie, ipv4forward, ipt_xmlconfig, xmlconfig, antispoofingpath, antispoofingfile, echocmd, logfile, verbose):
		self.naptime = 500 # milliseconds
		self.dryrun = dryrun
		self.iptablesbin = iptablesbin
		self.fwconfigpath = fwconfigpath
		self.rulesfile = rulesfile
	        self.syncookie = syncookie
	        self.ipv4forward = ipv4forward
		self.ipt_xmlconfig = ipt_xmlconfig
		self.xmlconfig = xmlconfig
		self.logfile = logfile
		self.verbose = verbose

		self.echocmd = echocmd
		self.antispoofing_path= antispoofingpath
		self.antispoofing_file= antispoofingfile

        	now = datetime.datetime.now()
	        now =  now.strftime("%Y/%m/%d %H:%M:%S")
		abyle_log2file(self.logfile, "", "", "", "")
		abyle_log2file(self.logfile, "", "", "", "####################")
		abyle_log2file(self.logfile, "", "", "", "STARTING UP FIREWALL")
		abyle_log2file(self.logfile, "", "", "", "####################")
		abyle_log2file(self.logfile, "", "", "", "")
		abyle_log2file(self.logfile, "", "", "", "startup time: "+now)
		abyle_log2file(self.logfile, "", "", "", "")
		
		abyle_log2file(self.logfile, "","","","IPv4 FORWARDING:")
		if self.verbose:
			abyle_output("","","","IPv4 FORWARDING:", "blue")
			
		if not self.ipv4forward == "NO":
			cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 1 > '+self.ipv4forward)
			if self.verbose:
                        	abyle_output("abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "ipv4 forwarding activated")
                        abyle_log2file(self.logfile, "abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "ipv4 forwarding activated")
                else:
                        cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 0 > '+self.ipv4forward)
			if self.verbose:
                        	abyle_output("abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "ipv4 forwarding deactivated")
                        abyle_log2file(self.logfile, "abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "ipv4 forwarding deactivated")

		if self.verbose:
			abyle_output("","","","SYNCOOKIE:", "blue")
		abyle_log2file(self.logfile, "","","","SYNCOOKIE:")
                if not self.syncookie == "NO":
                        cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 1 > '+self.syncookie)
			if self.verbose:
                        	abyle_output("abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "syncookie activated")
                        abyle_log2file(self.logfile, "abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "syncookie activated")
                else:
                        cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 0 > '+self.syncookie)
			if self.verbose:
                        	abyle_output("abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "syncookie deactivated")
                        abyle_log2file(self.logfile, "abyle_firewall", cmdErr.readlines(), cmdOut.readlines(), "syncookie deactivated")

                self.default_config = abyleparse(self.fwconfigpath, "default", self.rulesfile, self.ipt_xmlconfig)
                self.defaultrules =  self.default_config.getDefaultRules("head")

                for drule in self.defaultrules:
			if self.verbose:
				abyle_output("abyle_firewall_buildUpFinish_head", "", "", "default-rule: "+drule)
			abyle_log2file(self.logfile, "abyle_firewall_buildUpFinish_head", "", "", "default-rule: "+drule)
			if not self.dryrun:
               			cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+drule)

	def check_well_formedness(file):
       		try:
                	saxparser = make_parser()
                	saxparser.setContentHandler(ContentHandler())
                	saxparser.parse(file)
                	return "ok"
        	except Exception, e:
                	return str(file) + " is NOT well-formed! " + str(e)


	def buildUpFinish(self, verbose):
		self.verbose = verbose

		now = datetime.datetime.now()
		now =  now.strftime("%Y/%m/%d %H:%M:%S")
		self.defaultrules =  self.default_config.getDefaultRules("foot")

		if self.verbose:
			abyle_output("","","","SETTING UP DEFAULT RULES:", "blue")
		abyle_log2file(self.logfile, "","","","SETTING UP DEFAULT RULES:")
                for drule in self.defaultrules:
			if self.verbose:
				abyle_output("abyle_firewall_buildUpFinish_foot", "", "", "default-rule: "+drule)
			abyle_log2file(self.logfile, "abyle_firewall_buildUpFinish_foot", "", "", "default-rule: "+drule)
			if not self.dryrun:
                		cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+drule)
		
		abyle_log2file(self.logfile, "", "", "", "")
		abyle_log2file(self.logfile, "", "", "", "####################")
		abyle_log2file(self.logfile, "", "", "", "STARTUP DONE - "+now)
		abyle_log2file(self.logfile, "", "", "", "####################")
		abyle_log2file(self.logfile, "", "", "", "")



	def buildUp(self,protectedif,fwconfigpath, verbose):
		self.verbose = verbose

		
		self.protectedif = protectedif
		self.fwconfigpath = fwconfigpath
		if self.verbose:
			abyle_output("abyle_firewall", "", "", "Building a wall of fire in front of "+self.protectedif, "green")
		self.output = abyle_output("","","","")
		if not self.verbose:
			self.output.startup("securing "+self.protectedif)
		abyle_log2file(self.logfile, "abyle_firewall", "", "", "Building a wall of fire in front of "+self.protectedif)
		if os.path.exists(self.fwconfigpath+'/'+self.protectedif):

			checkWellformed = check_well_formedness(self.fwconfigpath+self.protectedif+self.xmlconfig)
        		if checkWellformed != "ok":
                		abyle_output("","","",checkWellformed, "red")
                		sys.exit(1)
        		else:
                		abyle_output("","","",self.fwconfigpath+self.protectedif+self.xmlconfig + " is a well-formed xml", "green")

			#parse the config file
		 	self.if_config = abyle_config_parse(self.fwconfigpath, self.protectedif, self.xmlconfig)
        		self.antispoofing = self.if_config.getConfig("antispoofing")
			self.logging = self.if_config.getConfig("logging")
       	 		self.allowping = self.if_config.getConfig("allowping")
       	 		self.masquerading = self.if_config.getConfig("masquerading")
       	 		self.portforwarding = self.if_config.getConfig("portforwarding")
        		self.tproxy = self.if_config.getConfig("transparent_proxy")
        		# end parse the config file

			self.antispoofing = string.upper(self.antispoofing)
			self.logging = string.upper(self.logging)
			self.allowping = string.upper(self.allowping)
			self.masquerading = string.upper(self.masquerading)
			self.portforwarding = string.upper(self.portforwarding)
			self.tproxy = string.upper(self.tproxy)

			if self.verbose:
				abyle_output("","","","ANTI SPOOFING:", "blue")
			else:
				self.output.startup(".")
				
			abyle_log2file(self.logfile, "","","","ANTI SPOOFING:")
			if self.antispoofing == "YES":
                		cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 1 > '+self.antispoofing_path+self.protectedif+'/'+self.antispoofing_file)
				if self.verbose:
                			abyle_output("abyle_firewall_buildUp", cmdErr.readlines(), cmdOut.readlines(), "anti spoofing for "+self.protectedif+" activated")
                		abyle_log2file(self.logfile, "abyle_firewall_buildUp", cmdErr.readlines(), cmdOut.readlines(), "anti spoofing for "+self.protectedif+" activated")
			else:
                		cmdIn, cmdOut, cmdErr = os.popen3(self.echocmd+' 0 > '+self.antispoofing_path+self.protectedif+'/'+self.antispoofing_file)
				if self.verbose:
                			abyle_output("abyle_firewall_buildUp", "", "", "anti spoofing for "+self.protectedif+" deactivated")
                		abyle_log2file(self.logfile, "abyle_firewall_buildUp", "", "", "anti spoofing for "+self.protectedif+" deactivated")


		
			self.if_config = abyleparse(self.fwconfigpath, self.protectedif, self.rulesfile, self.ipt_xmlconfig)
			self.rules =  self.if_config.getRules()
			if self.verbose:
				abyle_output("","","","RULES:", "blue")
			else:
				self.output.startup(".")
				
			abyle_log2file(self.logfile, "","","","RULES:")
			for rule in self.rules:
				time.sleep(self.naptime / 1000.0)
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_rules", "", "", self.protectedif+" "+rule)
				else:
					self.output.startup(".")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_rules", "", "", self.protectedif+" "+rule)
				if not self.dryrun:
                			cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+rule)

			if self.verbose:
				abyle_output("","","","PORTFORWARDING:", "blue")
			else:
				self.output.startup(".")
			abyle_log2file(self.logfile, "","","","PORTFORWARDING:")
			if self.portforwarding == "YES":
				self.portforwarding = self.if_config.getPortforwarding()
				for portfwd in self.portforwarding:
					if self.verbose:
						abyle_output("abyle_firewall_buildUp_portfwd", "", "", self.protectedif+" "+portfwd)
					abyle_log2file(self.logfile, "abyle_firewall_buildUp_portfwd", "", "", self.protectedif+" "+portfwd)
					if not self.dryrun:	
                				cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+portfwd)
			else:
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_portfwd", "", "", self.protectedif+" "+"PORTFORWARDING DISABLED")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_portfwd", "", "", self.protectedif+" "+"PORTFORWARDING DISABLED")
			
			if self.verbose:
				abyle_output("","","","TRANSPARENT PROXY:", "blue")
			else:
				self.output.startup(".")
			abyle_log2file(self.logfile, "","","","TRANSPARENT PROXY:")
			if self.tproxy == "YES":
				self.tproxy = self.if_config.getTproxy()
				for transproxy in self.tproxy:
					if self.verbose:
						abyle_output("abyle_firewall_buildUp_transproxy", "", "", self.protectedif+" "+transproxy)
					abyle_log2file(self.logfile, "abyle_firewall_buildUp_transproxy", "", "", self.protectedif+" "+transproxy)
					if not self.dryrun:
                				cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+transproxy)
			else:
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_tproxy", "", "", self.protectedif+" "+"TRANSPARENT PROXY DISABLED")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_tproxy", "", "", self.protectedif+" "+"TRANSPARENT PROXY DISABLED")


			if self.verbose:
				abyle_output("","","","LOGGING:", "blue")
			else:
				self.output.startup(".")
			abyle_log2file(self.logfile, "","","","LOGGING:")
			if self.logging == "YES":
				self.logging = self.if_config.getLogging()
				for log in self.logging:
					if self.verbose:
						abyle_output("abyle_firewall_buildUp_log", "", "", self.protectedif+" "+log)
					abyle_log2file(self.logfile, "abyle_firewall_buildUp_log", "", "", self.protectedif+" "+log)
					if not self.dryrun:
	               				cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+log)
			else:
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_logging", "", "", self.protectedif+" "+"LOGGING DISABLED")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_logging", "", "", self.protectedif+" "+"LOGGING DISABLED")

			if self.verbose:
				abyle_output("","","","ALLOW PING:", "blue")
			else:
				self.output.startup(".")
			abyle_log2file(self.logfile, "","","","ALLOW PING:")
			if self.allowping == "YES":
				self.allowping = self.if_config.getAllowPing()
				for ap in self.allowping:
					if self.verbose:
						abyle_output("abyle_firewall_buildUp_allowping", "", "", self.protectedif+" "+ap)
					abyle_log2file(self.logfile, "abyle_firewall_buildUp_allowping", "", "", self.protectedif+" "+ap)
					if not self.dryrun:
                				cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+ap)
			else:
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_allowping", "", "", self.protectedif+" "+"ALLOWPING DISABLED")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_allowping", "", "", self.protectedif+" "+"ALLOWPING DISABLED")

			if self.verbose:
				abyle_output("","","","MASQUERADING:", "blue")
			else:
				self.output.startup(".")
			abyle_log2file(self.logfile, "","","","MASQUERADING:")
			if self.masquerading == "YES":
				self.masquerading = self.if_config.getMasquerading()
				for mg in self.masquerading:
					if self.verbose:
						abyle_output("abyle_firewall_buildUp_masquerading", "", "", self.protectedif+" "+mg)
					abyle_log2file(self.logfile, "abyle_firewall_buildUp_masquerading", "", "", self.protectedif+" "+mg)
					if not self.dryrun:
						cmdIn, cmdOut, cmdErr = os.popen3(self.iptablesbin+' '+mg)
			else:
				if self.verbose:
					abyle_output("abyle_firewall_buildUp_masquerading", "", "", self.protectedif+" "+"MASQUERADING DISABLED")
				abyle_log2file(self.logfile, "abyle_firewall_buildUp_masquerading", "", "", self.protectedif+" "+"MASQUERADING DISABLED")
			if not self.verbose:
				self.output.startup("[OK]", "blue")
		else:
			if self.verbose:
				abyle_output("abyle_firewall", "", "", "ERROR: No directory found for interface "+self.protectedif+" in "+self.fwconfigpath, "red")
			abyle_log2file(self.logfile, "abyle_firewall", "", "", "ERROR: No directory found for interface "+self.protectedif+" in "+self.fwconfigpath)
